# Маршрутизация для API Gateway

# 1. Публичные endpoints авторизации (без проверки токена)
location ^~ /api/auth/ {
    limit_req zone=auth_limit burst=5 nodelay;
    
    proxy_pass http://auth_service:8081/;
    
    # Базовые заголовки
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# 2. Защищенные endpoints поиска (с проверкой авторизации)
location ^~ /api/search/ {
    limit_req zone=search_limit burst=15 nodelay;
    
    # Проверка авторизации через внутренний запрос
    auth_request /_validate_token;
    
    # Извлекаем данные пользователя из ответа auth service
    auth_request_set $auth_user_id $upstream_http_x_user_id; # Сохраняет данные из ответа в переменную $auth_user_id = что вернул auth_service в заголовке X-User-ID
    auth_request_set $auth_user_roles $upstream_http_x_user_roles; # $auth_user_roles = что вернул auth_service в заголовке X-User-Roles
    
    # Проксируем к сервису поиска
    proxy_pass http://search_service:8082/;
    
    # Передаем данные пользователя в search service
    proxy_set_header X-User-ID $auth_user_id;                           # ← Вот кто сделал запрос!
    proxy_set_header X-User-Roles $auth_user_roles;                     # ← Вот его права!
    proxy_set_header X-Auth-Validated "true";                           # ← Токен уже проверен!
    proxy_set_header X-Original-Authorization $http_authorization;      # ← Оригинальный токен
    
    # Search Service получает уже проверенного пользователя! Ему не нужно самому проверять токен.

    # Базовые заголовки
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# 3. Внутренний endpoint для проверки токена
location = /_validate_token {                                   # Точное совпадение, только для /_validate_token
    internal;                                                   # К нему нельзя обратиться снаружи, только изнутри Nginx
    
    proxy_method POST;
    proxy_pass http://auth_service:8081/api/v1/validate;
    
    # Не передаем тело оригинального запроса
    proxy_pass_request_body off;
    
    # Устанавливаем заголовки
    proxy_set_header Content-Type "application/json";
    proxy_set_header Content-Length "";
    
    # Формируем тело запроса с токеном
    proxy_set_body '{"token": "$http_authorization"}';
}